name: Cleanup Pre-releases

on:
  workflow_dispatch: # Permet de lancer l'action manuellement

jobs:
  delete-prereleases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete pre-releases
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Lister les releases (pagination à gérer si > 100, ici simple pour l'exemple)
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner,
              repo,
              per_page: 100
            });

            for (const release of releases) {
              if (release.prerelease) {
                console.log(`Suppression de la pre-release : ${release.tag_name}`);
            
                // 1. Supprimer la release
                await github.rest.repos.deleteRelease({
                  owner,
                  repo,
                  release_id: release.id
                });
            
                // 2. Supprimer le tag (optionnel, décommentez si nécessaire)
                /*
                try {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `tags/${release.tag_name}`
                  });
                } catch (e) {
                  console.log(`Tag ${release.tag_name} déjà supprimé ou introuvable.`);
                }
                */
              }
            }